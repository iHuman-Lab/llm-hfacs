
from pgmpy.models import BayesianNetwork
from pgmpy.estimators import MaximumLikelihoodEstimator
from pgmpy.inference import VariableElimination

file_path = r"C:\llm-hfacs\data\ASRS_all_factors.xlsx"
df = pd.read_excel(file_path).fillna(0)

# =========================
# 1) Preconditions (same list)
# =========================
PC_nodes = [
    "Human Factors:Communication Breakdown",
    "Human Factors:Confusion",
    "Human Factors:Distraction",
    "Human Factors:Fatigue",
    "Human Factors:Human-Machine Interface",
    "Human Factors:Other / Unknown",
    "Human Factors:Physiological - Other",
    "Human Factors:Situational Awareness",
    "Human Factors:Time Pressure",
    "Human Factors:Training / Qualification",
    "Human Factors:Troubleshooting",
    "Human Factors:Workload",
    "Anomaly:Ground Event / Encounter Weather / Turbulence",
    "Anomaly:Inflight Event / Encounter Weather / Turbulence",
    "Anomaly:Inflight Event / Encounter Wake Vortex Encounter",
    "Anomaly:Inflight Event / Encounter Bird / Animal",
    "Anomaly:Ground Event / Encounter Person / Animal / Bird",
    "Anomaly:Ground Event / Encounter FOD",
    "Anomaly:Ground Event / Encounter Object",
    "Anomaly:Inflight Event / Encounter Object",
    "Anomaly:Ground Event / Encounter Loss Of VLOS (UAS)",
    "Anomaly:Inflight Event / Encounter Fly Away (UAS)",
]

# =========================
# 2) Same full UA list
# =========================
UA_nodes_full = [
    "Anomaly:ATC Issue All Types",
    "Anomaly:Aircraft Equipment Problem Critical",
    "Anomaly:Aircraft Equipment Problem Less Severe",
    "Anomaly:Airspace Violation All Types",
    "Anomaly:Conflict Airborne Conflict",
    "Anomaly:Conflict Ground Conflict, Critical",
    "Anomaly:Conflict Ground Conflict, Less Severe",
    "Anomaly:Conflict NMAC",
    "Anomaly:Deviation - Altitude Excursion From Assigned Altitude",
    "Anomaly:Deviation - Altitude Overshoot",
    "Anomaly:Deviation - Altitude Undershoot",
    "Anomaly:Deviation - Speed All Types",
    "Anomaly:Deviation - Track / Heading All Types",
    "Anomaly:Deviation / Discrepancy - Procedural Clearance",
    "Anomaly:Deviation / Discrepancy - Procedural FAR",
    "Anomaly:Deviation / Discrepancy - Procedural Hazardous Material Violation",
    "Anomaly:Deviation / Discrepancy - Procedural Landing Without Clearance",
    "Anomaly:Deviation / Discrepancy - Procedural MEL / CDL",
    "Anomaly:Deviation / Discrepancy - Procedural Other / Unknown",
    "Anomaly:Deviation / Discrepancy - Procedural Published Material / Policy",
    "Anomaly:Deviation / Discrepancy - Procedural Unauthorized Flight Operations (UAS)",
    "Anomaly:Deviation / Discrepancy - Procedural Weight And Balance",
    "Anomaly:Flight Deck / Cabin / Aircraft Event Illness / Injury",
    "Anomaly:Flight Deck / Cabin / Aircraft Event Other / Unknown",
    "Anomaly:Flight Deck / Cabin / Aircraft Event Passenger Electronic Device",
    "Anomaly:Flight Deck / Cabin / Aircraft Event Passenger Misconduct",
    "Anomaly:Flight Deck / Cabin / Aircraft Event Smoke / Fire / Fumes / Odor",
    "Anomaly:Ground Event / Encounter Aircraft",
    "Anomaly:Ground Event / Encounter Fuel Issue",
    "Anomaly:Ground Event / Encounter Gear Up Landing",
    "Anomaly:Ground Event / Encounter Ground Equipment Issue",
    "Anomaly:Ground Event / Encounter Ground Strike - Aircraft",
    "Anomaly:Ground Event / Encounter Jet Blast",
    "Anomaly:Ground Event / Encounter Loss Of Aircraft Control",
    "Anomaly:Ground Event / Encounter Other / Unknown",
    "Anomaly:Ground Event / Encounter Vehicle",
    "Anomaly:Ground Excursion Ramp",
    "Anomaly:Ground Excursion Runway",
    "Anomaly:Ground Excursion Taxiway",
    "Anomaly:Ground Incursion Ramp",
    "Anomaly:Ground Incursion Runway",
    "Anomaly:Ground Incursion Taxiway",
    "Anomaly:Inflight Event / Encounter Aircraft",
    "Anomaly:Inflight Event / Encounter CFTT / CFIT",
    "Anomaly:Inflight Event / Encounter Fuel Issue",
    "Anomaly:Inflight Event / Encounter Loss Of Aircraft Control",
    "Anomaly:Inflight Event / Encounter Other / Unknown",
    "Anomaly:Inflight Event / Encounter Unstabilized Approach",
    "Anomaly:Inflight Event / Encounter VFR In IMC",
    "Anomaly:Inflight Event / Encounter Weather / Turbulence",
    "Anomaly:No Specific Anomaly Occurred Unwanted Situation",
]

# Second half for BN-3
mid = len(UA_nodes_full) // 2
UA_nodes = UA_nodes_full[mid:]

PC_nodes = [c for c in PC_nodes if c in df.columns]
UA_nodes = [c for c in UA_nodes if c in df.columns]

all_nodes = PC_nodes + UA_nodes
df_bn = df[all_nodes].astype("int64")
print("BN-3 data shape:", df_bn.shape)

# =========================
# 3) BUILD STRUCTURE: limited parents per UA
# =========================
max_parents = 3
key_parents = [pc for pc in PC_nodes][:max_parents]

edges = []
for pc in key_parents:
    for ua in UA_nodes:
        edges.append((pc, ua))

model = BayesianNetwork(edges)
print("BN-3 Nodes:", len(model.nodes()))
print("BN-3 Edges:", len(model.edges()))

# =========================
# 4) FIT AND SIMPLE QUERY
# =========================
model.fit(df_bn, estimator=MaximumLikelihoodEstimator)
print("BN-3 (Preconditions → Unsafe Acts, Part 2) fitted successfully.")

infer = VariableElimination(model)

ua_example = UA_nodes[0] if UA_nodes else None
if ua_example:
    q = infer.query(
        variables=[ua_example],
        evidence={key_parents[0]: 1}
    )
    print("\nExample query BN-3:")
    print(f"P({ua_example} | {key_parents[0]}=1)")
    print(q)


    # ========================================
# 5) SHOW CLEAN CPDs (WITH LABELED MULTI-PARENT TABLES)
# ========================================

print("\n===== CLEAN CPDs (ONLY IMPORTANT UA) =====")

final_UA_nodes = [n for n in UA_nodes if n in model.nodes()]

for node in final_UA_nodes:
    parents = model.get_parents(node)
    cpd = model.get_cpds(node)

    if not parents:  # no parents → show simple CPD
        print(f"\n### {node}  (No parents)")
        print(cpd)
        print("----------------------------------")
        continue

    # If 1 parent → display directly
    if len(parents) == 1:
        df_cpd = pd.DataFrame(cpd.values,
                              index=[f"{node}=0", f"{node}=1"],
                              columns=[f"{parents[0]}=0", f"{parents[0]}=1"])
        print(f"\n### {node}  ←  {parents}")
        print(df_cpd)
        print("----------------------------------")
        continue

    # If multiple parents → flatten properly with FULL labeling
    import itertools

    values_flat = cpd.values.reshape(2, -1)  # 2 rows → binary node
    parent_combos = list(itertools.product([0, 1], repeat=len(parents)))
    col_names = [" & ".join([f"{parents[i]}={combo[i]}" for i in range(len(parents))])
                 for combo in parent_combos]

    df_cpd = pd.DataFrame(values_flat,
                          index=[f"{node}=0", f"{node}=1"],
                          columns=col_names)

    print(f"\n### {node}  ←  {parents}")
    print(df_cpd)
    print("----------------------------------")
